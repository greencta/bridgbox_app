<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IrysMail - Connect Wallet</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Ethers.js CDN for wallet interaction - UPDATED to a reliable link -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js" xintegrity="sha512-FDc6O3T1qO5M4VoDcoTsgQPinps_jiaIChdDk3k_I2LuG3ktcO3ObrTmr2GGPx7iI9S9xKkU1TGGbyj2OJ4y1g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <!-- Irys Web SDK for interacting with the Irys Network -->
    <script src="https://unpkg.com/@irys/sdk/build/web.bundle.js"></script>
    <!-- Google Fonts - Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fc;
        }
    </style>
</head>
<body class="min-h-screen text-gray-800 flex flex-col items-center justify-center">

    <div class="w-full h-full flex flex-col items-center justify-center text-center p-8">
        <p class="text-sm font-semibold tracking-widest text-gray-500 mb-2">IRYSMAIL</p>
        <h1 class="text-5xl font-bold text-gray-900 mb-8">Start your experience now</h1>
        <button id="connect-button" class="bg-black text-white font-semibold px-8 py-3 rounded-full hover:bg-gray-800 transition-colors duration-300">
            Connect Wallet
        </button>
        <p id="connection-status" class="mt-4 text-sm"></p>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const connectButton = document.getElementById('connect-button');
            const connectionStatus = document.getElementById('connection-status');

            // Redirect if already connected
            if (localStorage.getItem('walletConnected') === 'true') {
                window.location.href = 'app.html';
                return;
            }

            // Main function to connect wallet and initialize Irys
            async function connectAndInitIrys() {
                connectionStatus.textContent = '';
                connectionStatus.classList.remove('text-red-600');
                connectionStatus.classList.add('text-gray-600');

                // 1. Check for a wallet provider
                if (!window.ethereum) {
                    connectionStatus.textContent = 'Please install a Web3 wallet like MetaMask or Rabby.';
                    connectionStatus.classList.add('text-red-600');
                    return;
                }

                connectButton.disabled = true;

                try {
                    // 2. Connect to the wallet
                    connectionStatus.textContent = 'Connecting to wallet...';
                    const provider = new ethers.providers.Web3Provider(window.ethereum);
                    await provider.send("eth_requestAccounts", []);
                    const signer = provider.getSigner();
                    const walletAddress = await signer.getAddress();
                    console.log("Wallet connected:", walletAddress);

                    // 3. Initialize Irys
                    connectionStatus.textContent = 'Initializing Irys Network...';
                    const url = "https://devnet.irys.xyz"; // Use devnet for testing
                    const token = "matic"; // Polygon Mumbai is a common devnet choice
                    
                    const webIrys = new WebIrys({
                        url: url,
                        token: token,
                        wallet: { rpcUrl: "https://matic-mumbai.chainstacklabs.com", name: "ethersv5", provider: provider }
                    });

                    await webIrys.ready();
                    console.log("Irys is ready:", webIrys.address);

                    // 4. Store connection state and redirect
                    localStorage.setItem('walletConnected', 'true');
                    localStorage.setItem('walletAddress', walletAddress);
                    
                    window.location.href = 'app.html';

                } catch (error) {
                    console.error("Connection failed:", error);
                    connectionStatus.classList.add('text-red-600');
                    if (error.code === 4001) {
                        connectionStatus.textContent = 'Wallet connection request rejected.';
                    } else if (error.message && error.message.includes("Could not find balance")) {
                        connectionStatus.textContent = 'Connected, but please switch to the Polygon Mumbai testnet in your wallet.';
                    } 
                    else {
                        connectionStatus.textContent = 'Connection failed. Please refresh and try again.';
                    }
                    connectButton.disabled = false;
                }
            }

            connectButton.addEventListener('click', connectAndInitIrys);
        });
    </script>
</body>
</html>
